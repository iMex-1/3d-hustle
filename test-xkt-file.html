<!DOCTYPE html>
<html>
<head>
  <title>Test XKT File</title>
</head>
<body>
  <h1>XKT File Tester</h1>
  <p>This will download and inspect your XKT file to see what's wrong</p>
  
  <input type="text" id="xktUrl" placeholder="Enter XKT URL" style="width: 500px">
  <button onclick="testXKT()">Test XKT File</button>
  
  <div id="results" style="margin-top: 20px; font-family: monospace;"></div>
  
  <script>
    async function testXKT() {
      const url = document.getElementById('xktUrl').value;
      const results = document.getElementById('results');
      
      if (!url) {
        results.innerHTML = '<p style="color: red;">Please enter a URL</p>';
        return;
      }
      
      results.innerHTML = '<p>Fetching file...</p>';
      
      try {
        const response = await fetch(url);
        
        if (!response.ok) {
          results.innerHTML = `<p style="color: red;">❌ HTTP ${response.status}: ${response.statusText}</p>`;
          return;
        }
        
        const arrayBuffer = await response.arrayBuffer();
        const bytes = new Uint8Array(arrayBuffer);
        
        // Read first 100 bytes
        const first100 = Array.from(bytes.slice(0, 100))
          .map(b => b.toString(16).padStart(2, '0'))
          .join(' ');
        
        // Try to read as text
        const textDecoder = new TextDecoder();
        const asText = textDecoder.decode(bytes.slice(0, 200));
        
        // Check XKT version (should be at byte 0-3 as uint32)
        const dataView = new DataView(arrayBuffer);
        const version = dataView.getUint32(0, true); // little-endian
        
        results.innerHTML = `
          <h3>File Analysis:</h3>
          <p><strong>Size:</strong> ${arrayBuffer.byteLength} bytes (${(arrayBuffer.byteLength / 1024 / 1024).toFixed(2)} MB)</p>
          <p><strong>XKT Version:</strong> ${version} ${version >= 1 && version <= 12 ? '✅ VALID' : '❌ INVALID (should be 1-12)'}</p>
          <p><strong>First 100 bytes (hex):</strong><br><code>${first100}</code></p>
          <p><strong>First 200 bytes (text):</strong><br><code>${asText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></p>
          
          ${version < 1 || version > 12 ? `
            <div style="background: #ffeeee; padding: 10px; margin-top: 10px; border-left: 4px solid red;">
              <h4>❌ This is NOT a valid XKT file!</h4>
              <p>The version number ${version} is invalid. Valid XKT files have versions 1-12.</p>
              <p>This file is either:</p>
              <ul>
                <li>Not actually an XKT file (maybe HTML error page)</li>
                <li>Corrupted during upload/download</li>
                <li>Created with an incompatible tool</li>
              </ul>
              <p><strong>Solution:</strong> Convert your IFC file using the official xeokit converter</p>
            </div>
          ` : `
            <div style="background: #eeffee; padding: 10px; margin-top: 10px; border-left: 4px solid green;">
              <h4>✅ This appears to be a valid XKT file!</h4>
              <p>Version ${version} is supported by xeokit.</p>
            </div>
          `}
        `;
        
      } catch (error) {
        results.innerHTML = `<p style="color: red;">❌ Error: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
