<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Cloudflare Worker</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: #1a1f2e;
      color: #fff;
    }
    h1 { color: #00A896; }
    .test-section {
      background: #232837;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    button {
      background: #00A896;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover { background: #00C8B3; }
    .result {
      background: #000;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success { color: #00A896; }
    .error { color: #FF3B30; }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 0.75rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      color: white;
      margin: 0.5rem 0;
    }
  </style>
</head>
<body>
  <h1>üß™ Cloudflare Worker Test Suite</h1>
  
  <div class="test-section">
    <h2>1. Test Worker Connection</h2>
    <p>Check if worker is responding</p>
    <button onclick="testConnection()">Test Connection</button>
    <div id="connection-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>2. Test File Upload (Admin)</h2>
    <p>Upload a test file to R2</p>
    <input type="text" id="admin-secret" placeholder="Enter admin secret" />
    <input type="file" id="upload-file" />
    <button onclick="testUpload()">Upload File</button>
    <div id="upload-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>3. Test File Download (Public)</h2>
    <p>Download the uploaded file (no auth needed)</p>
    <input type="text" id="download-path" placeholder="/models/test/test.txt" value="/models/test/test.txt" />
    <button onclick="testDownload()">Download File</button>
    <div id="download-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>4. Test File Delete (Admin)</h2>
    <p>Delete the test file</p>
    <input type="text" id="delete-path" placeholder="/models/test/test.txt" value="/models/test/test.txt" />
    <button onclick="testDelete()">Delete File</button>
    <div id="delete-result" class="result"></div>
  </div>

  <script>
    const WORKER_URL = 'https://bim-models-api.team-hustls3000.workers.dev';

    function log(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = isError ? 'result error' : 'result success';
    }

    async function testConnection() {
      log('connection-result', '‚è≥ Testing connection...');
      try {
        const response = await fetch(`${WORKER_URL}/models/nonexistent.txt`, {
          method: 'HEAD'
        });
        
        if (response.status === 404) {
          log('connection-result', '‚úÖ Worker is responding!\nStatus: 404 (expected - file doesn\'t exist)\nWorker is working correctly!');
        } else {
          log('connection-result', `‚úÖ Worker responded with status: ${response.status}`);
        }
      } catch (error) {
        log('connection-result', `‚ùå Connection failed:\n${error.message}`, true);
      }
    }

    async function testUpload() {
      const secret = document.getElementById('admin-secret').value;
      const fileInput = document.getElementById('upload-file');
      
      if (!secret) {
        log('upload-result', '‚ùå Please enter admin secret', true);
        return;
      }
      
      if (!fileInput.files[0]) {
        log('upload-result', '‚ùå Please select a file', true);
        return;
      }
      
      log('upload-result', '‚è≥ Uploading file...');
      
      try {
        const file = fileInput.files[0];
        const path = `/models/test/${file.name}`;
        
        const response = await fetch(`${WORKER_URL}${path}`, {
          method: 'PUT',
          headers: {
            'x-admin-secret': secret,
            'Content-Type': file.type || 'application/octet-stream'
          },
          body: file
        });
        
        if (response.ok) {
          const result = await response.json();
          log('upload-result', `‚úÖ Upload successful!\nPath: ${result.path}\nFile: ${file.name}\nSize: ${(file.size / 1024).toFixed(2)} KB`);
        } else {
          const error = await response.text();
          log('upload-result', `‚ùå Upload failed (${response.status}):\n${error}`, true);
        }
      } catch (error) {
        log('upload-result', `‚ùå Upload error:\n${error.message}`, true);
      }
    }

    async function testDownload() {
      const path = document.getElementById('download-path').value;
      
      if (!path) {
        log('download-result', '‚ùå Please enter file path', true);
        return;
      }
      
      log('download-result', '‚è≥ Downloading file...');
      
      try {
        const response = await fetch(`${WORKER_URL}${path}`);
        
        if (response.ok) {
          const contentType = response.headers.get('Content-Type');
          const contentLength = response.headers.get('Content-Length');
          
          // Try to read as text if it's small
          if (contentLength && parseInt(contentLength) < 1000000) {
            const text = await response.text();
            log('download-result', `‚úÖ Download successful!\nContent-Type: ${contentType}\nSize: ${contentLength} bytes\n\nContent preview:\n${text.substring(0, 500)}`);
          } else {
            log('download-result', `‚úÖ Download successful!\nContent-Type: ${contentType}\nSize: ${contentLength} bytes\n(File too large to preview)`);
          }
        } else {
          log('download-result', `‚ùå Download failed (${response.status}):\nFile not found or error occurred`, true);
        }
      } catch (error) {
        log('download-result', `‚ùå Download error:\n${error.message}`, true);
      }
    }

    async function testDelete() {
      const secret = document.getElementById('admin-secret').value;
      const path = document.getElementById('delete-path').value;
      
      if (!secret) {
        log('delete-result', '‚ùå Please enter admin secret', true);
        return;
      }
      
      if (!path) {
        log('delete-result', '‚ùå Please enter file path', true);
        return;
      }
      
      log('delete-result', '‚è≥ Deleting file...');
      
      try {
        const response = await fetch(`${WORKER_URL}${path}`, {
          method: 'DELETE',
          headers: {
            'x-admin-secret': secret
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          log('delete-result', `‚úÖ Delete successful!\nDeleted: ${result.deleted}`);
        } else {
          const error = await response.text();
          log('delete-result', `‚ùå Delete failed (${response.status}):\n${error}`, true);
        }
      } catch (error) {
        log('delete-result', `‚ùå Delete error:\n${error.message}`, true);
      }
    }
  </script>
</body>
</html>
